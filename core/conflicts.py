# core/conflicts.py
from __future__ import annotations

from core.types import Block

# ============================================================
# üß© –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ
# ============================================================


def _is_perf_pair(a: Block, b: Block) -> bool:
    """–û–±–∞ –±–ª–æ–∫–∞ ‚Äî –Ω–æ–º–µ—Ä–∞ (performance)."""
    return a.type == "performance" and b.type == "performance"


def _norm(s: str) -> str:
    """–ï–¥–∏–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω–∏ –∞–∫—Ç—ë—Ä–∞: trim + lower."""
    return (s or "").strip().lower()


def _shared_actors(a: Block, b: Block) -> set[str]:
    """
    –û–±—â–∏–µ –∞–∫—Ç—ë—Ä—ã –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π –∏–º—ë–Ω.
    –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –≤—Ä–æ–¥–µ '–°–æ–∫–æ–ª–æ–≤ ' vs '–°–æ–∫–æ–ª–æ–≤'.
    """
    names_a = {_norm(x.name) for x in a.actors}
    names_b = {_norm(x.name) for x in b.actors}
    return names_a & names_b


def _get_actor(block: Block, norm_name: str):
    """–ù–∞—Ö–æ–¥–∏—Ç –∞–∫—Ç—ë—Ä–∞ –≤ –±–ª–æ–∫–µ –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –∏–º–µ–Ω–∏."""
    for x in block.actors:
        if _norm(x.name) == norm_name:
            return x
    return None


# ============================================================
# ‚öîÔ∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã
# ============================================================

def strong_conflict(a: Block, b: Block) -> bool:
    """
    –°–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç: kv:true —Ä—è–¥–æ–º —Å kv:true.
    –ë–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π.
    """
    if not _is_perf_pair(a, b):
        return False
    return a.kv and b.kv


def weak_conflict(a: Block, b: Block) -> bool:
    """
    –°–ª–∞–±—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç ‚Äî –æ–±—â–∏–π –∞–∫—Ç—ë—Ä –≤ —Å–æ—Å–µ–¥–Ω–∏—Ö performance-–±–ª–æ–∫–∞—Ö.

    –ò—Å–∫–ª—é—á–µ–Ω–∏—è (–ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ü–û–ü–ê–†–ù–û –∫ –∫–∞–∂–¥–æ–º—É –æ–±—â–µ–º—É –∞–∫—Ç—ë—Ä—É):
      ‚Ä¢ —É –∞–∫—Ç—ë—Ä–∞ –≤ 'a' –µ—Å—Ç—å —Ç–µ–≥ 'early'  ‚Üí –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ 'b' (R ‚Üí R+1)
      ‚Ä¢ —É –∞–∫—Ç—ë—Ä–∞ –≤ 'b' –µ—Å—Ç—å —Ç–µ–≥ 'later'  ‚Üí –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ 'a' (R+1 ‚Üí R)
      ‚Ä¢ —É –ª—é–±–æ–≥–æ –∏–∑ –ø–∞—Ä—ã –µ—Å—Ç—å 'vo'       ‚Üí –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –ø–æ —ç—Ç–æ–π –ø–∞—Ä–µ –Ω–µ—Ç

    –ö–æ–Ω—Ñ–ª–∏–∫—Ç –µ—Å—Ç—å, –µ—Å–ª–∏ –Ω–∞—à—ë–ª—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –æ–±—â–∏–π –∞–∫—Ç—ë—Ä,
    –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø–æ–¥–ø–∞–¥–∞–µ—Ç –ø–æ–¥ –∏—Å–∫–ª—é—á–µ–Ω–∏—è.
    """
    if not _is_perf_pair(a, b):
        return False

    # –°–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ–Ω: —Ç—è–Ω—É—á–∫–æ–π –Ω–µ –ª–µ—á–∏—Ç—Å—è
    if strong_conflict(a, b):
        return False

    shared = _shared_actors(a, b)
    if not shared:
        return False

    for nm in shared:
        actor_a = _get_actor(a, nm)
        actor_b = _get_actor(b, nm)
        if actor_a is None or actor_b is None:
            # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π: –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω (–Ω–µ –¥–æ–ª–∂–Ω–æ —Å–ª—É—á–∞—Ç—å—Å—è)
            # ‚Äî –Ω–µ —Å—á–∏—Ç–∞–µ–º —ç—Ç—É –ø–∞—Ä—É –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω–æ–π.
            continue

        # –û–∑–≤—É—á–∫–∞ (vo) ‚Äî –≤—Å–µ–≥–¥–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è —Å–æ—Å–µ–¥—Å—Ç–≤–∞
        if "vo" in actor_a.tags or "vo" in actor_b.tags:
            continue

        # –†–∞–Ω–Ω–∏–π —É—Ö–æ–¥ –≤ A ‚Üí –º–æ–∂–Ω–æ –≤—ã—Å—Ç—É–ø–∞—Ç—å –≤ B
        if "early" in actor_a.tags:
            continue

        # –ü–æ–∑–¥–Ω–∏–π –≤—ã—Ö–æ–¥ –≤ B ‚Üí –º–æ–∂–Ω–æ –≤—ã—Å—Ç—É–ø–∞—Ç—å –≤ A
        if "later" in actor_b.tags:
            continue

        # –ù–∏ –æ–¥–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ ‚Üí –∏–º–µ–Ω–Ω–æ –ø–æ —ç—Ç–æ–π –ø–∞—Ä–µ –µ—Å—Ç—å —Å–ª–∞–±—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç
        return True

    # –í—Å–µ –æ–±—â–∏–µ –∞–∫—Ç—ë—Ä—ã –ø–æ–ø–∞–ª–∏ –ø–æ–¥ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
    return False


def kv_conflict(a: Block, b: Block) -> bool:
    """
    –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ API: kv:true —Ä—è–¥–æ–º —Å kv:true.
    (–î—É–±–ª–∏—Ä—É–µ—Ç strong_conflict –ø–æ —Å–º—ã—Å–ª—É, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ.)
    """
    if not _is_perf_pair(a, b):
        return False
    return a.kv and b.kv
